{% extends "base.html" %}
{% block title %}{{ note.title }}{% endblock %}
{% block content %}
<style>
  .note-detail-card{max-width:760px;margin:60px auto;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:2rem 2.5rem;}
  h2{color:#1e3a8a;font-weight:800;margin-bottom:1rem;}
  .note-meta p{margin:.4rem 0;color:#374151;}
  .btn{padding:.6rem 1rem;border-radius:8px;font-weight:600;cursor:pointer;border:none}
  .btn-download{background:linear-gradient(90deg,#3b82f6,#60a5fa);color:#fff}
  .btn-like{background:#f3f4f6;color:#1e3a8a;border:1px solid #d1d5db}
  .btn-back{background:#e5e7eb;color:#1e3a8a;margin-bottom:1rem}
  .comment{border-bottom:1px solid #f3f4f6;padding:.8rem 0}
  .comment-actions{margin-top:.3rem}
  .comment-actions button{background:none;border:none;color:#1e3a8a;font-size:.85rem;cursor:pointer;margin-right:.6rem}
  textarea{width:100%;padding:.8rem;border:1px solid #ccc;border-radius:8px;margin-top:.8rem}
</style>

<div class="note-detail-card">
  <a class="btn btn-back" href="{{ request.session.last_notes_list_url|default:'/notes/' }}">‚¨ÖÔ∏è Geri D√∂n</a>


  <h2>{{ note.title }}</h2>
  <div class="note-meta">
    <p><strong>Ders:</strong> {{ note.course.name }}</p>
    <p><strong>D√∂nem:</strong> {{ note.semester }}</p>
    <p><strong>A√ßƒ±klama:</strong> {{ note.description|default:"-" }}</p>
    <p><strong>Y√ºkleyen:</strong> {{ note.user.username }}</p>
    <p><strong>ƒ∞ndirilmeler:</strong> {{ note.download_count }}</p>
  </div>

  <div style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap;">
    <a href="{% url 'download_note' note.pk %}" class="btn btn-download">üì• Notu ƒ∞ndir</a>
    <button id="likeBtn" class="btn btn-like">‚ù§Ô∏è Beƒüen</button>
    <span id="likeCount" style="align-self:center;color:#1e3a8a;font-weight:600;">{{ note.likes }}</span>

    {% if note.user.id == request.user.id %}
  <form action="{% url 'delete_note' note.id %}" method="post" style="display:inline" onsubmit="return confirm('Bu not silinecek. Emin misin?');">
    {% csrf_token %}
    <button type="submit" class="btn btn-like" style="background:#fee2e2;border-color:#fecaca;color:#991b1b">üóë Sil</button>
  </form>
  <a href="{% url 'edit_note' note.id %}" class="btn btn-like">‚úèÔ∏è D√ºzenle</a>
{% endif %}

  </div>

  <div class="comments">
    <h3 style="color:#1e3a8a;margin-top:2rem;">üí¨ Yorumlar</h3>
    <div id="commentList"></div>
    <textarea id="commentText" placeholder="Yorumunuzu yazƒ±n..."></textarea>
    <button class="btn btn-download" id="sendComment">G√∂nder</button>
  </div>
</div>

<script>
const noteId={{ note.id }};
const token=localStorage.getItem('access');

// Beƒüeni durumunu ilk y√ºklemede getir
async function checkLikeStatus(){
  try{
    const res=await fetch(`/api/notes/${noteId}/like/`,{headers:{'Authorization':'Bearer '+token}});
    if(!res.ok) return;
    const data=await res.json();
    document.getElementById('likeCount').innerText=data.total_likes;
    document.getElementById('likeBtn').innerText=data.liked?'üíî Beƒüeniyi Geri Al':'‚ù§Ô∏è Beƒüen';
  }catch{}
}

document.getElementById('likeBtn').addEventListener('click', async()=>{
  try{
    const res=await fetch(`/api/notes/${noteId}/like/`,{method:'POST',headers:{'Authorization':'Bearer '+token}});
    const data=await res.json();
    document.getElementById('likeCount').innerText=data.total_likes;
    document.getElementById('likeBtn').innerText=data.liked?'üíî Beƒüeniyi Geri Al':'‚ù§Ô∏è Beƒüen';
  }catch{ alert('Beƒüeni hatasƒ±'); }
});

// Yorum listele/ekle/d√ºzenle/sil
async function loadComments(){
  const list=document.getElementById('commentList');
  list.innerHTML='Y√ºkleniyor...';
  try{
    const res=await fetch(`/api/notes/${noteId}/comments/`,{headers:{'Authorization':'Bearer '+token}});
    const data=await res.json();
    list.innerHTML= data.length ? data.map(c=>`
      <div class='comment' data-id='${c.id}'>
        <strong>${c.user}</strong> <small>${c.created_at}</small>
        <p class='content'>${c.content}</p>
        ${c.user_id=={{ request.user.id }}?`
          <div class='comment-actions'>
            <button onclick='editComment(${c.id},"${c.content.replace(/"/g,'&quot;')}")'>‚úèÔ∏è D√ºzenle</button>
            <button onclick='deleteComment(${c.id})'>üóë Sil</button>
          </div>`:''}
      </div>`).join('') : "<p>Hen√ºz yorum yok.</p>";
  }catch{ list.innerHTML='Yorumlar alƒ±namadƒ±.'; }
}

document.getElementById('sendComment').addEventListener('click', async()=>{
  const text=document.getElementById('commentText').value.trim();
  if(!text) return;
  await fetch(`/api/notes/${noteId}/comments/`,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({content:text})
  });
  document.getElementById('commentText').value='';
  loadComments();
});

async function editComment(id,content){
  const div=document.querySelector(`.comment[data-id='${id}']`);
  div.innerHTML=`<textarea id='edit-${id}'>${content}</textarea>
  <button class="btn btn-download" onclick="saveEdit(${id})">Kaydet</button>
  <button class="btn btn-like" onclick="loadComments()">ƒ∞ptal</button>`;
}
async function saveEdit(id){
  const newText=document.getElementById(`edit-${id}`).value.trim();
  if(!newText) return;
  await fetch(`/api/notes/${noteId}/comments/`,{
    method:'PUT',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({id,content:newText})
  });
  loadComments();
}
async function deleteComment(id){
  if(!confirm('Yorumu silmek istiyor musun?')) return;
  await fetch(`/api/notes/${noteId}/comments/`,{
    method:'DELETE',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({id})
  });
  loadComments();
}

checkLikeStatus();
loadComments();
</script>
{% endblock %}
