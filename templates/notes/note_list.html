{% extends "base.html" %}
{% load static %}
{% block title %}T√ºm Notlar{% endblock %}
{% block content %}
<style>
  h2 {
    color: #1e3a8a;
    font-weight: 800;
    font-size: 2rem;
    margin-bottom: 2rem;
    background: linear-gradient(to right, #1e3a8a, #60a5fa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .filter-box {
    background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(243,244,246,0.9));
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    margin-bottom: 2.5rem;
    backdrop-filter: blur(10px);
  }

  .filter-row {
    display: flex;
    gap: 1.2rem;
    flex-wrap: wrap;
  }

  select, button {
    padding: 0.8rem 1rem;
    border-radius: 10px;
    font-size: 1rem;
    border: 1px solid #bfdbfe;
  }

  button {
    background: linear-gradient(90deg,#3b82f6,#60a5fa);
    color: #fff;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: .3s;
  }

  .note-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
    gap: 1.8rem;
  }

  .note-card {
    background: linear-gradient(145deg,rgba(255,255,255,0.95),rgba(243,244,246,0.9));
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    padding: 1.5rem;
    transition: all .3s ease;
    position: relative;
  }

  .note-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  }

  .note-card h4 {
    color:#1e3a8a;
    font-weight:700;
    font-size:1.2rem;
    margin-bottom:0.5rem;
  }

  .note-meta {
    font-size: .9rem;
    color:#4b5563;
    margin: .5rem 0 1rem 0;
  }

  .btn {
    display:inline-block;
    text-align:center;
    padding: .6rem 1rem;
    border-radius:10px;
    font-weight:600;
    font-size:.9rem;
    cursor:pointer;
    text-decoration:none;
    transition:.3s;
  }

  .btn-detail {
    background:#f8fafc;
    color:#1e3a8a;
    border:1px solid #bfdbfe;
  }

  .btn-download {
    background:linear-gradient(90deg,#3b82f6,#60a5fa);
    color:#fff;
  }

  .btn-like {
    background:#f3f4f6;
    color:#1e3a8a;
    border:1px solid #d1d5db;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:5px;
  }

  .btn-like:hover {
    background:#e0e7ff;
  }

  .btn-detail:hover, .btn-download:hover {
    transform: translateY(-2px);
    box-shadow:0 6px 15px rgba(0,0,0,0.15);
  }

  .card-btns {
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:.6rem;
  }
</style>

<h2>üìö T√ºm Notlar</h2>

<div class="filter-box">
  <form method="get" class="filter-row">
    <select name="university">
      <option value="">√úniversite</option>
      {% for uni in universities %}
        <option value="{{ uni.id }}" {% if request.GET.university == uni.id|stringformat:"s" %}selected{% endif %}>{{ uni.name }}</option>
      {% endfor %}
    </select>
    <select name="department">
      <option value="">B√∂l√ºm</option>
      {% for dep in departments %}
        <option value="{{ dep.id }}" {% if request.GET.department == dep.id|stringformat:"s" %}selected{% endif %}>{{ dep.name }}</option>
      {% endfor %}
    </select>
    <select name="course">
      <option value="">Ders</option>
      {% for c in courses %}
        <option value="{{ c.id }}" {% if request.GET.course == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
    <button type="submit">Ara</button>
  </form>
</div>

<div class="note-grid">
  {% for note in notes %}
  <div class="note-card" data-note="{{ note.id }}">
    <h4>{{ note.title }}</h4>
    <small>{{ note.course }} - {{ note.semester }}</small>
    <div class="note-meta">
      <strong>Y√ºkleyen:</strong> {{ note.user.username }}<br>
      üì• {{ note.download_count }} indirme
    </div>
    <div class="card-btns">
      <a href="{% url 'note_detail' note.id %}" class="btn btn-detail">üëÅ Detay</a>
      <a href="{% url 'download_note' note.id %}" class="btn btn-download">üì• ƒ∞ndir</a>
      <button class="btn btn-like" onclick="toggleLike({{ note.id }}, this)">‚ù§Ô∏è <span class="like-count">{{ note.likes }}</span></button>
    </div>
  </div>
  {% empty %}
  <p style="text-align:center;color:#4b5563;">Hen√ºz not y√ºklenmemi≈ü.</p>
  {% endfor %}
</div>

<script>
const token = localStorage.getItem('access');

// üîπ T√ºm notlar y√ºklendiƒüinde kullanƒ±cƒ± hangi notlarƒ± beƒüenmi≈ü √∂ƒüren
document.addEventListener('DOMContentLoaded', async () => {
  if(!token) return;
  const cards = document.querySelectorAll('.note-card');
  for (const card of cards) {
    const id = card.dataset.note;
    const btn = card.querySelector('.btn-like');
    try {
      const res = await fetch(`/api/notes/${id}/like/`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if(!res.ok) continue;
      const data = await res.json();
      const countEl = btn.querySelector('.like-count');
      countEl.textContent = data.total_likes;
      btn.innerHTML = data.liked
        ? 'üíî <span class="like-count">'+data.total_likes+'</span>'
        : '‚ù§Ô∏è <span class="like-count">'+data.total_likes+'</span>';
    } catch {}
  }
});

// üîπ Toggle (beƒüen / geri al)
async function toggleLike(noteId, btn){
  try{
    const res = await fetch(`/api/notes/${noteId}/like/`, {
      method:'POST',
      headers:{'Authorization':'Bearer '+token}
    });
    const data = await res.json();
    const countEl = btn.querySelector('.like-count');
    countEl.textContent = data.total_likes;
    btn.innerHTML = data.liked
      ? 'üíî <span class="like-count">'+data.total_likes+'</span>'
      : '‚ù§Ô∏è <span class="like-count">'+data.total_likes+'</span>';
  }catch{
    alert('Beƒüeni i≈ülemi ba≈üarƒ±sƒ±z.');
  }
}
</script>

{% endblock %}
