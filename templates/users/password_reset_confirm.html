{% extends "base.html" %}
{% load static %}
{% block title %}Yeni Şifre Belirle{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/theme.css' %}">

<style>
    .auth-box {
        max-width: 450px;
        margin: var(--spacing-2xl) auto;
        padding: var(--spacing-2xl);
        text-align: center;
    }

    .auth-box h2 {
        color: var(--primary-purple);
        margin-bottom: var(--spacing-lg);
        font-weight: 800;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
    }

    .auth-box input {
        width: 100%;
        padding: 14px 18px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        font-size: 0.95rem;
        background: var(--bg-glass-light);
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .auth-box input:focus {
        outline: none;
        border-color: var(--primary-purple);
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .auth-box button {
        width: 100%;
        background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-dark-purple) 100%);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        padding: 14px;
        cursor: pointer;
        font-weight: 700;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-md);
    }

    .auth-box button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .auth-box .msg {
        margin-top: var(--spacing-md);
        font-size: 0.9rem;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    .msg.success {
        color: var(--success);
        background: rgba(52, 199, 89, 0.1);
    }

    .msg.error {
        color: var(--error);
        background: rgba(255, 59, 48, 0.1);
    }

    .msg.info {
        color: var(--primary-purple);
        background: rgba(102, 126, 234, 0.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .auth-box {
            margin: var(--spacing-lg) var(--spacing-md);
            padding: var(--spacing-lg);
        }
    }
</style>

<div class="glass auth-box">
    <h2>
        <i class="fa-solid fa-key"></i> Yeni Şifre Belirle
    </h2>
    <form id="confirmForm">
        <input type="password" id="password" placeholder="Yeni Şifre" required>
        <button type="submit">Şifreyi Güncelle</button>
    </form>
    <p id="msg" class="msg"></p>
</div>

<script>
const uid = "{{ uid }}";
const token = "{{ token }}";

document.getElementById("confirmForm").addEventListener("submit", async(e)=>{
    e.preventDefault();
    const password = document.getElementById("password").value;
    const msg = document.getElementById("msg");
    msg.className = 'msg info';
    msg.innerText = "⏳ Güncelleniyor...";
    
    try{
        const res = await fetch("/api/auth/password/reset/confirm/", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({uid, token, password})
        });
        const data = await res.json();
        
        if(res.ok){
            msg.className = 'msg success';
            msg.innerText = "✅ Şifre başarıyla güncellendi.";
            setTimeout(() => window.location.href="/login/", 1500);
        } else {
            msg.className = 'msg error';
            msg.innerText = "⚠️ " + (data.error || "Bağlantı geçersiz.");
        }
    } catch {
        msg.className = 'msg error';
        msg.innerText = "⚠️ Sunucu hatası.";
    }
});
</script>
{% endblock %}
