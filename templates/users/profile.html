{% extends "base.html" %}
{% load static %}
{% block title %}Profilim{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/theme.css' %}">

<style>
    /* Profil Özel Stilleri */
    .profile-page-container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Profil Header */
    .profile-card { 
        padding: var(--spacing-xl); 
        display: flex; 
        align-items: center; 
        gap: var(--spacing-xl); 
        position: relative; 
        overflow: hidden; 
    }

    .profile-avatar-xl { 
        width: 120px; 
        height: 120px; 
        background: linear-gradient(135deg, var(--primary-purple) 0%, var(--primary-dark-purple) 100%); 
        color: white; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 3rem; 
        font-weight: 800; 
        border: 5px solid white; 
        box-shadow: var(--shadow-md); 
        z-index: 2; 
        position: relative; 
        flex-shrink: 0;
    }

    .profile-avatar-xl img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        border-radius: 50%; 
    }

    .profile-info {
        flex: 1;
    }

    .profile-info h1 {
        margin: 0;
        font-size: 2rem;
        color: var(--text-primary);
        font-weight: 800;
    }

    .rank-tag { 
        background: var(--warning); 
        color: black; 
        font-weight: 700; 
        padding: 5px 12px; 
        border-radius: var(--radius-full); 
        font-size: 0.85rem; 
        display: inline-block; 
        margin-top: var(--spacing-xs); 
        box-shadow: var(--shadow-sm); 
    }

    .profile-university {
        color: var(--text-secondary);
        margin: var(--spacing-xs) 0;
    }

    /* İstatistikler */
    .stats-row { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .stat-item { 
        text-align: center; 
    }

    .stat-val { 
        font-size: 1.5rem; 
        font-weight: 800; 
        color: var(--text-primary); 
        display: block; 
    }

    .stat-label { 
        font-size: 0.875rem; 
        color: var(--text-secondary); 
        font-weight: 600; 
        margin-top: var(--spacing-xs);
    }

    /* Sekmeler (Tabs) */
    .tabs { 
        display: flex; 
        gap: var(--spacing-sm); 
        margin: var(--spacing-xl) 0 var(--spacing-md); 
        border-bottom: 2px solid rgba(0,0,0,0.05); 
        padding-bottom: var(--spacing-sm); 
        overflow-x: auto; 
    }

    .tab-btn { 
        padding: var(--spacing-sm) var(--spacing-md); 
        background: none; 
        border: none; 
        font-size: 1rem; 
        font-weight: 600; 
        color: var(--text-secondary); 
        cursor: pointer; 
        border-radius: var(--radius-md); 
        transition: all 0.3s ease; 
        white-space: nowrap; 
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .tab-btn:hover { 
        background: rgba(0,0,0,0.05); 
    }

    .tab-btn.active { 
        background: white; 
        color: var(--primary-purple); 
        box-shadow: var(--shadow-sm); 
    }

    /* İçerik Kartları */
    .note-list-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
        gap: var(--spacing-lg); 
    }

    .mini-card { 
        background: white; 
        padding: var(--spacing-lg); 
        border-radius: var(--radius-md); 
        box-shadow: var(--shadow-sm); 
        transition: all 0.3s ease; 
        border: 1px solid rgba(0,0,0,0.05); 
        position: relative; 
    }

    .mini-card:hover { 
        transform: translateY(-4px); 
        box-shadow: var(--shadow-md); 
    }

    .card-actions { 
        position: absolute; 
        top: var(--spacing-md); 
        right: var(--spacing-md); 
        opacity: 0; 
        transition: all 0.3s ease; 
        display: flex; 
        gap: var(--spacing-xs); 
    }

    .mini-card:hover .card-actions { 
        opacity: 1; 
    }

    .card-action-btn {
        padding: 6px 10px;
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Form Stilleri */
    .profile-form { 
        display: grid; 
        gap: var(--spacing-md); 
    }

    .profile-form label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .profile-form input, 
    .profile-form select {
        padding: 12px 16px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(0,0,0,0.1);
        font-size: 1rem;
        width: 100%;
        background: var(--bg-glass-light);
        transition: all 0.3s ease;
    }

    .profile-form input:focus, 
    .profile-form select:focus {
        outline: none;
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
    }

    .profile-form .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .profile-form .file-input-wrapper input[type="file"] {
        padding: var(--spacing-xs);
    }

    .tab-content {
        animation: fadeIn 0.4s ease;
    }

    /* Responsive - Mobile First */
    @media (max-width: 768px) {
        .profile-card { 
            flex-direction: column; 
            text-align: center; 
            padding: var(--spacing-lg); 
        }

        .profile-avatar-xl {
            width: 100px;
            height: 100px;
            font-size: 2.5rem;
        }

        .profile-info h1 {
            font-size: 1.75rem;
        }

        .stats-row { 
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .card-actions { 
            opacity: 1; 
        }

        .note-list-grid {
            grid-template-columns: 1fr;
        }

        .tabs {
            gap: var(--spacing-xs);
        }

        .tab-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.875rem;
        }
    }
</style>

<div class="profile-page-container">
    <!-- Profil Kartı -->
    <div class="glass profile-card">
        <div class="profile-avatar-xl">
            {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.username }}">
            {% else %}
                {{ user.username|make_list|first|upper }}
            {% endif %}
        </div>
        <div class="profile-info">
            <h1>{{ user.username }}</h1>
            <div class="rank-tag">{{ user.rank }}</div>
            <p class="profile-university">{{ user.university.name|default:"Üniversite Seçilmedi" }}</p>

            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-val">{{ uploaded_notes.count }}</span>
                    <span class="stat-label">Yükleme</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val">{{ total_downloads }}</span>
                    <span class="stat-label">İndirilme</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" style="color: var(--success); display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <i class="fa-solid fa-bolt" style="font-size: 1rem;"></i> {{ total_xp }}
                    </span>
                    <span class="stat-label">Seviye Puanı (XP)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val">{{ liked_notes|length }}</span>
                    <span class="stat-label">Favori</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sekmeler -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('uploads')">
            <i class="fa-solid fa-cloud-arrow-up"></i> Yüklediklerim
        </button>
        <button class="tab-btn" onclick="openTab('likes')">
            <i class="fa-solid fa-heart"></i> Beğendiklerim
        </button>
        <button class="tab-btn" onclick="openTab('settings')">
            <i class="fa-solid fa-gear"></i> Ayarlar
        </button>
    </div>

    <!-- Sekme İçerikleri -->
    <div id="uploads" class="tab-content">
        <div class="note-list-grid">
            {% for note in uploaded_notes %}
            <div class="mini-card">
                <div style="font-weight: 700; margin-bottom: var(--spacing-xs); color: var(--text-primary);">{{ note.title }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    <i class="fa-solid fa-book"></i> {{ note.course.name }} <br>
                    <span style="color: var(--success);"><i class="fa-solid fa-download"></i> {{ note.download_count }}</span> •
                    <span style="color: var(--error);"><i class="fa-solid fa-heart"></i> {{ note.likes }}</span>
                </div>
                <div class="card-actions">
                    <a href="{% url 'edit_note' note.id %}" class="card-action-btn" style="background: var(--warning); color: black;">
                        <i class="fa-solid fa-pen"></i>
                    </a>
                    <a href="{% url 'note_detail' note.id %}" class="card-action-btn" style="background: var(--primary-purple); color: white;">
                        <i class="fa-solid fa-eye"></i>
                    </a>
                </div>
            </div>
            {% empty %}
            <p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Henüz not yüklemedin.</p>
            {% endfor %}
        </div>
    </div>

    <div id="likes" class="tab-content" style="display: none;">
        <div class="note-list-grid">
            {% for note in liked_notes %}
            <div class="mini-card">
                <div style="font-weight: 700; margin-bottom: var(--spacing-xs); color: var(--text-primary);">{{ note.title }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    <i class="fa-regular fa-user"></i> {{ note.user.username }}
                </div>
                <a href="{% url 'note_detail' note.id %}" class="btn btn-secondary" style="margin-top: var(--spacing-sm); width: 100%; text-align: center;">
                    Görüntüle
                </a>
            </div>
            {% empty %}
            <p style="grid-column: 1/-1; text-align: center; color: var(--text-light);">Henüz hiçbir notu beğenmedin.</p>
            {% endfor %}
        </div>
    </div>

    <div id="settings" class="tab-content" style="display: none;">
        <div class="glass" style="padding: var(--spacing-xl);">
            <h3 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Profili Düzenle</h3>
            <form id="profileForm" class="profile-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Kullanıcı Adı</label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" placeholder="Kullanıcı Adı" required>
                </div>
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" placeholder="E-posta" required>
                </div>
                <div class="form-group">
                    <label>Üniversite</label>
                    <select id="university" name="university">
                        <option value="">Üniversite Seç</option>
                        {% for uni in universities %}
                            <option value="{{ uni.id }}" {% if user.university and user.university.id == uni.id %}selected{% endif %}>{{ uni.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Profil Fotoğrafı</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="avatarInput" name="avatar" accept="image/*">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Kaydet</button>
                <p id="msg" style="margin-top: var(--spacing-sm); font-weight: 600;"></p>
            </form>
        </div>
    </div>
</div>

<script>
    // CSRF Token al
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Tab Geçişleri
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

        document.getElementById(tabName).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    // Profil Güncelleme Formu
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('profileForm');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const msg = document.getElementById('msg');
                msg.innerText = "⏳ Kaydediliyor...";
                msg.style.color = "var(--primary-purple)";

                const formData = new FormData();
                formData.append('username', document.getElementById('username').value);
                formData.append('email', document.getElementById('email').value);
                
                const universityValue = document.getElementById('university').value;
                if (universityValue) {
                    formData.append('university', universityValue);
                }
                
                const file = document.getElementById('avatarInput').files[0];
                if (file) {
                    formData.append('avatar', file);
                }

                try {
                    const token = localStorage.getItem('access');
                    const csrftoken = getCookie('csrftoken');
                    
                    const headers = {
                        'X-CSRFToken': csrftoken
                    };
                    
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }

                    const res = await fetch('/api/auth/profile/update/', {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    });

                    const data = await res.json();

                    if (res.ok) {
                        msg.innerText = "✅ Profil başarıyla güncellendi!";
                        msg.style.color = "var(--success)";
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        msg.innerText = "⚠️ " + (data.error || data.message || "Bir hata oluştu.");
                        msg.style.color = "var(--error)";
                        console.error('Hata:', data);
                    }
                } catch (error) {
                    msg.innerText = "⚠️ Sunucu hatası. Lütfen tekrar deneyin.";
                    msg.style.color = "var(--error)";
                    console.error('Hata:', error);
                }
            });
        }
    });
</script>
{% endblock %}
